<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/public.css" />
		<link rel="stylesheet" href="../css/in.css" />
	</head>

	<body>
		<!--扫描不存在的页面-->
		<div class="notHave" id='notHave'>
			<h3><span class="close"id='notHaveClose'>×</span></h3>
			<div class="notPic"></div>
			<!--<button id='failScan'>重新扫描</button>-->
		</div>
		<!--第一次扫描完成的操作页面-->
		<div class="firstScan" id='firstScan'>
			<div class="firstScanCon">
				<h3><span class="close"id='close'>×</span></h3>
				<ul class="medicationScan" id='medicationScan'>
				</ul>
				<ul class="scanDetail">
					<li><span class="liquid">泵速</span><span class="liquidNum" id='liquidNum'>4ml/h</span></li>
					<li><span class="liquid">执行时间</span><span class="liquidNum"><input type="button" onclick='selectTime("activeTime")' id="activeTime" value="选择时间" /></span></li>
				</ul>
			</div>

			<div class="scanOper">
				<button id='firstSure'>确认执行</button>
				<!--<button id='restart'>重新扫描</button>-->
			</div>
		</div>
		<!--重复扫描的操作页面-->
		<div class="rescan" id='rescan'>
			<div class="rescanCon">
				<h3><span class="close"id='closePage'>×</span></h3>
				<h4>
				<span class="operName"id='operName'>操作<i></i></span>
				<div class="stop operItem"id='stop'>
					<ul>
						<li id="continue"status='5'>继续</li>
					</ul>
				</div>
				<div class="active operItem"id='active'>
					<ul>
						<li class="liObj"status='1'>修改泵速</li>
						<li class="liObj"status='7'>已用量</li>
						<li class="liObj"status='6'>暂停</li>
						<li class="liObj"status='4'>停止</li>
					</ul>
				</div>
			</h4>
				<ul class="medicationScan" id='remedicationScan'>

				</ul>
				<ul class="scanDetail">
					<li><span class="liquid">总量</span><span class="liquidUnit">ml</span><span class="liquidNum" id='total'></span></li>
					<li><span class="liquid">已用量</span><span class="liquidUnit">ml</span><span class="liquidNum" id='actual'></span></li>
					<li><span class="liquid">泵速</span><span class="liquidUnit">ml/h</span><span class="liquidNum"><input type="text" id='speed'/></span></li>
					<ul id="changePart">

					</ul>
				</ul>
			</div>

			<div class="scanOper">
				<button id='sure'>确认执行</button>
				<!--<button id='rescanBtn'>重新扫描</button>-->
			</div>
		</div>

		<div class="scanCon" id='scanCon'>
			<div class="SCAN" id='SCAN'>

			</div>
			<button id="cancel">取消扫二维码</button>
		</div>
		<!--饮食和用药的主体部分-->
		<div class="listContainer" id='listContainer'>

			<span class="listTitle select"><i></i>饮食</span>
			<span class="listTitle"><i class="medicaIcon"></i>用药</span>
			<!--饮食内容区域-->
			<div class="diet tabContainer">
				<h2>饮食方法及量</h2>
				<div class="dietMethod">
					<span class="dietName" id='dietName'></span><span class="dietNum" id='dietNum'></span>
				</div>
				<h2>入量——营养</h2>
				<!--日期和时间-->
				<div class="dataTime">
					<span id="currentDate"></span>
					<span class="time">
		    			<span><i class="one"></i></span>
					<span class="now"><input type="button"value="12:45" onclick="pickTime()"  /><i class="two"></i></span>
					<span><i class="three"></i></span>
					</span>
				</div>
				<!--输入项部分-->
				<div class="items" id='items'>

				</div>
			</div>
			<!--用药内容区域-->
			<div class="medication tabContainer" id='med'>
				<!--时间日期-->
				<div class="dataTime">
					<span id="currentDateTime"></span>
				</div>
				<h2>入量——口服药</h2>
				<div class="inDetails OralMedicine" id='OralMedicine'>

				</div>
				<h2>入量——特殊治疗</h2>
				<div class="inDetails specialTreat" id='specialTreat'>
				</div>
				<h2>入量——输液单 <s id='ScanCodeBtn'></s></h2>
				<!--输液单展示-->
				<div id="InfusionList">
				</div>
			</div>
			<!--保存-->
			<div class="dietSave saveSection saveBack">
				<button id='saveBtn'>保存并上传</button>
			</div>
			<div class="medicationSave saveSection saveBack">
				<!--<button id='scanBtn'><i></i>扫描二维码</button>-->
				<button id='saveSpecial'>保存并上传</button>
					
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/config.js"></script>
		<script src="../js/tool.js"></script>
		<script src="../js/public.js"></script>
		<script src="../lib/template/template.js"></script>
		<!--饮食部分的模板-->
		<script type='text/template' id='itemsDisabledTpl'>
			<ul class='disabled'>
				<li>

					<span class="itemName">经口喂养</span>
					<input type="button" value="选择时间" class='selectTime' />
					<input type="text" placeholder="请输入" disabled/>
					<span class='unit'>ml</span>
				</li>
				<li>

					<span class="itemName">鼻饲量</span>
					<input type="button" value="选择时间" class='selectTime' />
					<input type="text" placeholder="请输入" disabled/>
					<span class='unit'>ml</span>
				</li>
				<li class="lastLi">

					<span class="itemName">胃潴留量</span>
					<input type="button" value="选择时间" class='selectTime' />
					<input type="text" placeholder="请输入" disabled/>
					<span class='unit'>ml</span>
				</li>
			</ul>
		</script>
		<script type='text/template' id='itemsTpl'>

			<ul>
				{{if list}} {{each list as value i}}
				<li>

					{{if value.IntakeSupplyName=='经口'}}
					<span class="itemName" name='{{value.IntakeSupplyName}}'>经口喂养</span> {{else if value.IntakeSupplyName=='鼻饲'}}
					<span class="itemName" name='{{value.IntakeSupplyName}}'>鼻饲量</span> {{else if value.IntakeSupplyName=='胃潴留'}}
					<span class="itemName" name='{{value.IntakeSupplyName}}'>胃潴留量</span> {{/if}} {{if value.OperateTime}}
					<input type="button" value="{{value.OperateTime.substr(value.OperateTime.indexOf(" "),6)}}" onclick="selectTime('{{value.IntakeSupplyName}}')" class='selectTime' id='{{value.IntakeSupplyName}}' /> {{else}}
					<input type="button" value="选择时间" onclick="selectTime('mouthID')" class='selectTime' id='mouthID' /> {{/if}}
					<input type="text" placeholder="请输入" value='{{value.IntakeNumber}}' class='itemNum' />
					<span class='unit'>ml</span>
				</li>
				{{/each}} {{else}}
				<li>

					<span class="itemName">经口喂养</span>
					<input type="button" value="选择时间" onclick="selectTime('mouth')" class='selectTime' id='mouth' />
					<input type="text" placeholder="请输入" class='itemNum' />
					<span class='unit'>ml</span>
				</li>
				<li>

					<span class="itemName">鼻饲量</span>
					<input type="button" value="选择时间" onclick="selectTime('nose')" class='selectTime' id='nose' />
					<input type="text" placeholder="请输入" class='itemNum' />
					<span class='unit'>ml</span>
				</li>
				<li class="lastLi">

					<span class="itemName">胃潴留量</span>
					<input type="button" value="选择时间" onclick="selectTime('stomach')" class='selectTime' id='stomach' />
					<input type="text" placeholder="请输入" class='itemNum' />
					<span class='unit'>ml</span>
				</li>
				{{/if}}
			</ul>

		</script>
		<script type='text/template' id='specialTpl'>
			<ul>
				{{each list as value i}}
				<li class='saveItem'>
					<span id='OralName' IntakeName='{{value.IntakeName}}' IntakeUseType='{{value.IntakeUseType}}' OrderCode='{{value.OrderCode}}' IntakeCode='{{value.IntakeCode}}' IntakeNumber='{{value.IntakeNumber}}'OrderNumber='{{value.OrderNumber}}'IntakeUnit='{{value.IntakeUnit}}'ParentNumber='{{value.ParentNumber}}'Frequcy='{{value.Frequcy}}'>{{value.Remarks}}</span>
					<input type="button" value='添加时间' class="addTime" onclick="addTimes('{{value.Remarks}}')" />
				</li>
				<div class="times" id='{{value.Remarks}}'>
					<span class="clearBtn"></span> {{if value.Value}} {{each value.Value.split('-') as item}}
					<span class="singleTime">{{item}}</span> {{/each}} {{/if}}
				</div>
				{{/each}}
			</ul>
		</script>
		<!--用药的模板-->
		<script type='text/template' id='updateTpl'>
			<li><span class="liquid">时间</span><span class="liquidNum"><input type="button" onclick='updateTime("doTime")' id="doTime" value="选择时间" /></span></li>
			<li><span class="liquid">实入量</span><span class="liquidNum"><input type="text"  placeholder='请输入'id='actualNum'/>ml</span></li>
		</script>
		<script type='text/template' id='hasUseTpl'>
			<li><span class="liquid">已完成</span><span class="liquidNum"><input type="checkBox"id='isComplete'/></span></li>
			<li><span class="liquid">时间</span><span class="liquidNum"><input type="button" onclick='updateTime("doTime")' id="doTime" value="选择时间" /></span></li>
			<li><span class="liquid">实入量</span><span class="liquidNum"><input type="text"  placeholder='请输入'id='actualNum'/>ml</span></li>

		</script>
		<script type='text/template' id='pauseTpl'>
			<li><span class="liquid">时间</span><span class="liquidNum"><input type="button" onclick='updateTime("doTime")' id="doTime" value="选择时间" /></span></li>
			<li><span class="liquid">实入量</span><span class="liquidNum"><input type="text"  placeholder='请输入'id='actualNum'/>ml</span></li>

		</script>
		<script type='text/template' id='stopTpl'>
			<li><span class="liquid">时间</span><span class="liquidNum"><input type="button" onclick='updateTime("doTime")' id="doTime" value="选择时间" /></span></li>
			<li><span class="liquid">实入量</span><span class="liquidNum"><input type="text"  placeholder='请输入'id='actualNum'/>ml</span></li>
		</script>
		<script type='text/template' id='continueTpl'>
			<li><span class="liquid">时间</span><span class="liquidNum"><input type="button" onclick='updateTime("doTime")' id="doTime" value="选择时间" /></span></li>
		</script>
		<!--输液单的模板-->
		<script type='text/template' id='infusionTpl'>
			{{each datas as value i}}
			<div class="infusionGroup" id='{{OPERATE_STATUS}}' }>
				<ul>
					{{each value.list as item}}
					<li>{{item.Remarks}}</li>
					{{/each}}
				</ul>
				<ul>
					<li><span class="totalNum">总量:&nbsp;<span class="totalValue"id='totalValue'>{{value.list[0].INTAKE_TOTAL}}</span>ml</span>&nbsp;<span class="Consumption">实际用量<span class="ConsumptionValue"id='ConsumptionValue'>{{value.list[0].USED_TOTAL}}</span>ml</span>
					</li>
					<li><span class="methods">给药方式:&nbsp;<span class="methodsValue">{{value.list[0].INTAKE_SUPPLY_NAME}}</span></span>
					</li>
					<li><span class="pumpSpeed">泵速:&nbsp;<span class="pumpSpeedValue"id='pumpSpeedValue'>{{value.list[0].INTAKE_PUMPSPEED}}</span></span>
					</li>
					<li><span class="executeTime">执行时间:<span class="executeTimeValue">{{value.list[0].OPERATE_TIME}}</span></span>
					</li>
					<li><span class="executor">执行人:<span class="executorValue">{{value.list[0].OPERATE_USER_NAME}}</span></span>
					</li>
				</ul>
				{{if value.list[0].OPERATE_STATUS==0 || value.list[0].OPERATE_STATUS==1 || value.list[0].OPERATE_STATUS==5 || value.list[0].OPERATE_STATUS==7}}
				<div class="groupOper opers" status='status'>
					<button class="activeOper">修改泵速</button>
					<button class="activeOper">已用量</button>
					<button class="activeOper">暂停</button>
					<button class="activeOper">停止</button>
					<div class="operPart" status='1'>
						<ul>
							<li><span>泵速</span><input type="text" placeholder="请输入泵速" id='speedId' class='inputDom' />ml/h</li>
							<li><span>时间</span><input type="button" onclick="updateTime('status1')" id='status1' value='选择时间' class='itemTime' /></li>
							<li><span>实入量</span><input type="text" placeholder="请输入实入量" id='inNum' class='status1 fact inputDom' />ml</li>
						</ul>
						<div class="sureUpdate" IntakeCode='{{value.list[0].INTAKE_CODE}}' IsOver='0' id='affected'>
							确定
						</div>
					</div>
					<div class="operPart" status='7'>
						<ul>
							<li><span>已完成</span><input type="checkbox" id='isComplete' /></li>
							<li><span>时间</span><input type="button" onclick="updateTime('status7')" id='status7' value='选择时间' class='itemTime' /></li>
							<li><span>实入量</span><input type="text" placeholder="请输入实入量" id='inNum' class='status7 fact inputDom' />ml</li>

						</ul>
						<div class="sureUpdate" IntakeCode='{{value.list[0].INTAKE_CODE}}' IsOver='0' id='affected'>
							确定
						</div>
					</div>
					<div class="operPart" status='5'>
						<ul>
							<li><span>时间</span><input type="button" onclick="updateTime('status5')" id='status5' value='选择时间' class='itemTime' /></li>
							<li><span>实入量</span><input type="text" placeholder="请输入实入量" id='inNum' class='status5 fact inputDom' />ml</li>
						</ul>
						<div class="sureUpdate" IntakeCode='{{value.list[0].INTAKE_CODE}}' IsOver='0' id='affected'>
							确定
						</div>
					</div>
					<div class="operPart" status='4'>
						<ul>
							<li><span>时间</span><input type="button" onclick="updateTime('status4')" id='status4' value='选择时间' class='itemTime' /></li>
							<li><span>实入量</span><input type="text" placeholder="请输入实入量" id='inNum' class='status4 fact inputDom' />ml</li>

						</ul>
						<div class="sureUpdate" IntakeCode='{{value.list[0].INTAKE_CODE}}' IsOver='0' id='affected'>
							确定
						</div>
					</div>
				</div>
				{{else if value.list[0].OPERATE_STATUS==6}}
				<div class="continumBotton opers"status='status'>
						<button id='begin'class="activeOper">继续</button>
						<div class="operPart" status='6'>
							<ul>
								<li><span>泵速</span><input type="text" placeholder="请输入泵速" id='speedId' class='inputDom' />ml/h</li>
								<li><span>时间</span><input type="button" onclick="selectTime('updateId')" id='updateId' value='选择时间' class='itemTime' /></li>
							</ul>
							<div class="sureUpdate" IsOver='0' IntakeCode='{{value.list[0].INTAKE_CODE}}' id='affected'>
								确定
							</div>
						</div>
				</div>
				{{/if}}
			</div>
			{{/each}}

		</script>

		<!--入量的饮食部分-->
		<script type="text/javascript">
			mui.init();
			//			tab栏切换
			var listContainer = document.getElementById('listContainer');
			//			获取tab栏标题
			var listTitles = document.getElementsByClassName('listTitle');
			//			获取tab栏标题
			var tabContainers = document.getElementsByClassName('tabContainer');
			//			获取保存的按钮
			var saves = document.getElementsByClassName('saveSection');
			var inputFlag = false;
			//			给标题注册点击事件，并实现tab栏切换
			for(var i = 0; i < listTitles.length; i++) {
				listTitles[i].setAttribute('index', i);
				listTitles[i].addEventListener('tap', function() {
					var thisIndex = parseInt(this.getAttribute('index'));
					for(var j = 0; j < listTitles.length; j++) {
						listTitles[j].classList.remove('select');
						tabContainers[j].style.display = 'none';
						saves[j].style.display = 'none';
					}
					this.classList.add('select');
					tabContainers[thisIndex].style.display = 'block';
					saves[thisIndex].style.display = 'block';
				})
			}
			if(window.plus) {
				plusReady();
			} else {
				document.addEventListener("plusready", plusReady, false);
			}
			//			获取时间列表
			var timeArr = [];
			var flag = false;

			function plusReady() {
				//			处理床位列表传值
				var w = plus.webview.currentWebview();
				var patientBed = w.PatientBed;
				var patientName = w.PatientName;
				var patientNumber = w.PatientNumber;
				var MRN = w.MRN;
				var detailMain = plus.webview.getWebviewById('detail_main.html');
				var savespecial = '';
				var saveDiet = '';
				window.addEventListener('hasChange', function() {
					mui.confirm('当前存在未保存的数据，是否保存？', function(e) {
						if(e.index == 1) {
							savespecial();
							saveDiet();
							mui.fire(detailMain, 'selectTrue', {
								isSave: true
							})
						} else {
							listContainer.classList.remove('hasChange');
							mui.fire(detailMain, 'getParams', {
								hasChange: listContainer.classList.contains('hasChange')
							})
							mui.fire(detailMain, 'selectTrue', {
								isSave: false
							})
						}
					})
				})

				//--------------------获取饮食方式及量---------------------------
				//			获取输入项的Dom
				var items = document.getElementById('items');
				mui.ajax({
					url: url,
					type: 'get',
					data: {
						msgBody: JSON.stringify({
							PatientMRN: MRN,
							StartTime: new Date().Format('yyyy-MM-dd') + " 07:01:00",
							EndTime: getNextDay() + ' 07:00:00'
						}),
						msgHeader: JSON.stringify({
							ServerName: 'GetYYType',
							Format: 'json',
							CallOperator: '',
							Certificate: '123456'
						})
					},
					dataType: 'json',
					success: function(data) {
						//					动态加载饮食方式计量
						var dietName = document.getElementById('dietName');
						var dietNum = document.getElementById('dietNum');
						if(data.Code == 0) {
							//					获取饮食方式计量Dom	
							if(data.Contents.length == 0) {
								dietName.innerHTML = '请确认饮食方式方式是否存在';
								dietNum.innerHTML = '';
								var html = template('itemsDisabledTpl', {});
								items.innerHTML = html;
							} else {
								dietName.innerHTML = data.Contents[0].OperateName;
								dietNum.innerHTML = data.Contents[0].OperateContent;

								flag = true;
								//			获取时间dom
								var three = document.getElementsByClassName('three')[0];
								var one = document.getElementsByClassName('one')[0];
								var two = document.getElementsByClassName('two')[0];
								//			获取时间列表
								mui.ajax({
									url: url,
									type: 'post',
									data: {
										msgBody: JSON.stringify({
											PatientMRN: MRN,
											CurrentTime: new Date().Format("yyyy-MM-dd hh:mm:ss")
										}),
										msgHeader: JSON.stringify({
											ServerName: 'GetTimeList',
											Format: 'json',
											CallOperator: '',
											Certificate: '123456'
										})
									},
									dataType: 'json',
									success: function(data) {
										for(var i = 0; i < data.Contents.length; i++) {
											timeArr.push(data.Contents[i].Time);
										}
										var hour = new Date().getHours();
										//设置时间的默认值为当前时间
										for(var i = 0; i < timeArr.length; i++) {
											var colonIndex = timeArr[i].indexOf(':');
											var nextIndex = i + 1 >= timeArr.length - 1 ? timeArr.length - 1 : i + 1;
											if(timeArr[i].substring(0, colonIndex) <= hour && timeArr[nextIndex].substring(0, colonIndex) > hour) {
												two.innerHTML = timeArr[i];
												two.setAttribute('index', i);
												if(i <= 0) {
													three.innerHTML = timeArr[i + 1];
													three.setAttribute('index', i + 1);
													one.innerHTML = timeArr[timeArr.length - 1];
													one.setAttribute('index', timeArr.length - 1);
													continue;
												}
												if(i >= timeArr.length - 1) {
													one.innerHTML = timeArr[i - 1];
													one.setAttribute('index', i - 1);
													three.innerHTML = timeArr[0];
													three.setAttribute('index', 0);
													continue;
												}
												one.innerHTML = timeArr[i - 1];
												one.setAttribute('index', i - 1);
												three.innerHTML = timeArr[i + 1];
												three.setAttribute('index', i + 1);
											}
										}
										var timeBoxs = document.getElementsByClassName('time')[0].children;
										//设置位置
										for(var i = 0; i < timeBoxs.length; i++) {
											timeBoxs[i].style.left = 170 * i / 100 + 'rem';
										}
										//					如果饮食及量显示,则可以对时间列表进行操作
										document.getElementsByClassName('items')[0].classList.remove('hasSave');
										if(flag) {
											//						查找当前时间的记录

											mui.ajax({
												url: url,
												type: 'post',
												data: {
													msgBody: JSON.stringify({
														PatientMRN: MRN,
														OperateTime: currentDate.innerHTML + " " + two.innerHTML + ":00"
													}),
													msgHeader: JSON.stringify({
														ServerName: 'GetYYIntakeByTime',
														Format: 'json',
														CallOperator: '',
														Certificate: '123456'
													})
												},
												dataType: 'json',
												success: function(data) {
													var html = template('itemsTpl', {
														list: data.Contents
													});
													items.innerHTML = html;
													var inputs = document.getElementsByClassName('itemNum');

													for(var i = 0; i < inputs.length; i++) {

														inputs[i].addEventListener('change', function() {
															listContainer.classList.add('hasChange');
															mui.fire(detailMain, 'getParams', {
																hasChange: listContainer.classList.contains('hasChange')
															})
														})

													}

													if(data.Code != 0) {
														mui.toast('该时间点未保存数据');
													} else {
														document.getElementsByClassName('items')[0].classList.add('hasSave');
													}

												},
												error: function() {
													var html = template('itemsDisabledTpl', {
														list: data.Contents
													});
													items.innerHTML = html;
													mui.toast('服务器异常，请稍后再试');
												}
											});
											//					
											//						修改时间
											two.addEventListener('tap', function() {
												this.style.display = 'none';
												this.previousElementSibling.value = this.innerHTML;

											})
											//						查询最近的记录
											one.addEventListener('tap', function() {
												document.getElementsByClassName('items')[0].classList.remove('hasSave');
												if(!this.innerHTML) {
													return;
												}
												var thisInnerHtml = this.innerHTML;
												var tapIndex = parseInt(one.getAttribute('index'));
												if(tapIndex == 9) {
													currentDate.innerHTML = getPreDay(currentDate.innerHTML);
												}
												two.innerHTML = timeArr[tapIndex];
												two.setAttribute('index', tapIndex);
												three.innerHTML = timeArr[tapIndex + 1];
												three.setAttribute('index', parseInt(tapIndex + 1));
												if(tapIndex <= 0) {
													one.innerHTML = '';
													one.setAttribute('index', 0);
												} else {
													one.innerHTML = timeArr[tapIndex - 1];
													one.setAttribute('index', tapIndex - 1);
												}
												mui.ajax({
													url: url,
													type: 'post',
													data: {
														msgBody: JSON.stringify({
															PatientMRN: MRN,
															OperateTime: currentDate.innerHTML + " " + thisInnerHtml + ":00",
														}),
														msgHeader: JSON.stringify({
															ServerName: 'GetYYIntakeByTime',
															Format: 'json',
															CallOperator: '',
															Certificate: '123456'
														})
													},
													beforeSend: function() {
														plus.nativeUI.showWaiting('加载中…');
													},
													dataType: 'json',
													success: function(data) {
														if(data.Code == 0) {
															plus.nativeUI.closeWaiting();
															var html = template('itemsTpl', {
																list: data.Contents
															});
															items.innerHTML = html;
														} else {
															plus.nativeUI.closeWaiting();
															var html = template('itemsTpl', {
																list: data.Contents
															});
															items.innerHTML = html;
														}
														var inputs = document.getElementsByClassName('itemNum');
														for(var i = 0; i < inputs.length; i++) {
															inputs[i].addEventListener('change', function() {

																listContainer.classList.add('hasChange');
																mui.fire(detailMain, 'getParams', {
																	hasChange: listContainer.classList.contains('hasChange')
																})
															})

														}
													},
													error: function() {
														plus.nativeUI.closeWaiting();
														mui.toast('服务器异常，请稍后再试');
													}
												})
											})
											//						切换到最新的时间
											three.addEventListener('tap', function() {
												document.getElementsByClassName('items')[0].classList.remove('hasSave');
												if(!this.innerHTML) {
													return;
												}
												var thisInnerHtml = this.innerHTML;
												var tapIndex = parseInt(three.getAttribute('index'));
												if(tapIndex == 10) {
													currentDate.innerHTML = getNextDay();
												}
												two.innerHTML = timeArr[tapIndex];
												two.setAttribute('index', tapIndex);
												one.innerHTML = timeArr[tapIndex - 1];
												one.setAttribute('index', tapIndex - 1);
												if(tapIndex >= timeArr.length - 1) {
													three.innerHTML = "";
													three.setAttribute('index', timeArr.length - 1);
												} else {
													three.innerHTML = timeArr[tapIndex + 1];
													three.setAttribute('index', parseInt(tapIndex + 1));
												}

												mui.ajax({
													url: url,
													type: 'post',
													data: {
														msgBody: JSON.stringify({
															PatientMRN: MRN,
															OperateTime: currentDate.innerHTML + " " + thisInnerHtml + ":00"
														}),
														msgHeader: JSON.stringify({
															ServerName: 'GetYYIntakeByTime',
															Format: 'json',
															CallOperator: '',
															Certificate: '123456'
														})
													},
													beforeSend: function() {
														plus.nativeUI.showWaiting('加载中…');
													},
													dataType: 'json',
													success: function(data) {
														if(data.Code == 0) {
															plus.nativeUI.closeWaiting();
															var html = template('itemsTpl', {
																list: data.Contents
															});
															items.innerHTML = html;
														} else {
															plus.nativeUI.closeWaiting();
															var html = template('itemsTpl', {
																list: data.Contents
															});
															items.innerHTML = html;
														}
														var inputs = document.getElementsByClassName('itemNum');
														for(var i = 0; i < inputs.length; i++) {
															inputs[i].addEventListener('change', function() {

																listContainer.classList.add('hasChange');
																mui.fire(detailMain, 'getParams', {
																	hasChange: listContainer.classList.contains('hasChange')
																})
															})

														}
													},
													error: function() {
														plus.nativeUI.closeWaiting();
														var html = template('itemsDisabledTpl', {
															list: data.Contents
														});
														items.innerHTML = html;
														mui.toast('服务器异常，请稍后再试');
													}
												});
											});

											//						保存并上传数据
											document.getElementById('saveBtn').addEventListener('tap', function() {
												saveDiet();
											})
											saveDiet = function() {
												if(!listContainer.classList.contains('hasChange')) {
													mui.toast('请填写数据');
													return;
												}
												var saveObj = {
													PatientMRN: MRN,
													PatientNumber: patientNumber,
													PatientName: patientName,
													OperateTime: currentDate.innerHTML + " " + two.innerHTML + ":00",
													UserCode: JSON.parse(window.localStorage.getItem('loginInfo')).UserName,
													UserName: JSON.parse(window.localStorage.getItem('loginInfo')).Name,
													ColumnID: parseInt(two.getAttribute('index')) + 3 + '',
													IntakeList: []
												};
												//							获取要保存的DOM节点
												var selectTimes = document.getElementsByClassName('selectTime');
												var itemNames = document.getElementsByClassName('itemName');
												var itemNums = document.getElementsByClassName('itemNum');
												for(var i = 0; i < 3; i++) {
													saveObj.IntakeList.push({
														IntakeSupplyName: itemNames[i].getAttribute('name'),
														IntakeNumber: itemNums[i].value,
														IntakeUseType: '营养',
														OperateTime: currentDate.innerHTML + selectTimes[i].value + ':00'
													})
												}
												mui.ajax({
													url: url,
													type: 'post',
													data: {
														msgBody: JSON.stringify(saveObj),
														msgHeader: JSON.stringify({
															ServerName: 'SaveIntake',
															Format: 'json',
															CallOperator: '',
															Certificate: '123456'
														})
													},
													beforeSend: function() {
														plus.nativeUI.showWaiting('正在保存中…');
													},
													dataType: 'json',
													success: function(data) {
														if(data.Code == 0) {
															setTimeout(function() {
																mui.toast('数据保存成功');
																plus.nativeUI.closeWaiting();
																document.getElementsByClassName('items')[0].classList.add('hasSave');
																listContainer.classList.remove('hasChange');
																mui.fire(detailMain, 'getParams', {
																	hasChange: listContainer.classList.contains('hasChange')
																})
															}, 2000);

														} else {
															plus.nativeUI.closeWaiting();
															mui.toast('服务器异常，请稍后再试');
														}
													},
													error: function() {
														plus.nativeUI.closeWaiting();
														mui.toast('服务器异常，请稍后再试');
													}
												})
											}

										}
									},
									error: function() {
										plus.nativeUI.closeWaiting();
										mui.toast('服务器异常，请稍后再试');
									}
								});
							}

						} else {
							dietName.innerHTML = '请确认饮食方式方式是否存在';
							dietNum.innerHTML = '';
							var html = template('itemsDisabledTpl', {});
							items.innerHTML = html;

						}
					},
					error: function() {
						mui.toast('服务器异常，请稍后再试');
						dietName.innerHTML = '请确认饮食方式方式是否存在';
						dietNum.innerHTML = '';
						var html = template('itemsDisabledTpl', {});
						items.innerHTML = html;
					}
				})

				//--------------------用药部分-----------------------------
				//				日期的设置
				var currentDateTime = document.getElementById('currentDateTime');
				currentDateTime.innerHTML = new Date().Format("yyyy-MM-dd");

				//				添加时间控件

				getOralOrSpecial('0', 'OralMedicine');
				getOralOrSpecial('1', 'specialTreat');
				//				获取口服药或者特殊治疗的方法
				function getOralOrSpecial(intakeType, id) {
					mui.ajax({
						url: url,
						type: 'get',
						data: {
							msgBody: JSON.stringify({
								PatientMRN: MRN,
								StartTime: new Date().Format('yyyy-MM-dd') + " 07:01:00",
								EndTime: getNextDay() + ' 07:00:00',
								IntakePoType: intakeType
							}),
							msgHeader: JSON.stringify({
								ServerName: 'GetIntakePo',
								Format: 'json',
								CallOperator: '',
								Certificate: '123456'
							})
						},
						dataType: 'json',
						success: function(data) {
							if(data.Code == 0) {
								if(data.Contents.length != 0) {
									var html = template('specialTpl', {
										list: data.Contents
									});
									document.getElementById(id).innerHTML = html;
									var times = document.getElementsByClassName('times');
									var clearBtns = document.getElementsByClassName('clearBtn');
									for(var i = 0; i < times.length; i++) {
										if(times[i].children.length == 1) {
											times[i].style.display = 'none';
											times[i].previousElementSibling.style.border = '1px solid #bebebe'
										} else {
											times[i].style.display = 'block';
											times[i].previousElementSibling.style.borderBottom = 'none'
										}
									}
									mui('.times').on('tap', '.clearBtn', function() {

										this.parentNode.removeChild(this.parentNode.lastElementChild);
										if(!this.nextElementSibling) {
											this.parentNode.style.display = 'none';
											this.parentNode.previousElementSibling.style.borderBottom = '1px solid #bebebe';
										}
									});
								}

							}
						},
						error: function(data) {
							mui.toast('服务器异常，请稍后再试');
						}
					})
				}
				//				保存口服和特殊治疗

				document.getElementById('saveSpecial').addEventListener('tap', function() {
					savespecial();
				});
				savespecial = function() {
					var saveItems = document.getElementsByClassName('saveItem');
					var saveParam = {
						PatientMRN: MRN,
						PatientNumber: patientNumber,
						PatientName: patientName,
						OperateTime: new Date().Format("yyyy-MM-dd hh:mm:ss"),
						UserCode: JSON.parse(window.localStorage.getItem('loginInfo')).UserName,
						UserName: JSON.parse(window.localStorage.getItem('loginInfo')).Name,
						IntakeList: []
					};
					for(var i = 0; i < saveItems.length; i++) {
						var thisTimesDom = saveItems[i].nextElementSibling.getElementsByClassName('singleTime');
						var thisTimes = '';
						for(var j = 0; j < thisTimesDom.length; j++) {
							thisTimes += thisTimesDom[j].innerHTML + '-';
						}
						thisTimes = thisTimes.substr(0, thisTimes.length - 1);
						saveParam.IntakeList.push({
							OrderNumber:saveItems[i].firstElementChild.getAttribute('OrderNumber'),
							IntakeNumber:saveItems[i].firstElementChild.getAttribute('IntakeNumber'),
							IntakeName: saveItems[i].firstElementChild.getAttribute('IntakeName'),
							IntakeUnit: saveItems[i].firstElementChild.getAttribute('IntakeUnit'),
							OperateTime: new Date().Format("yyyy-MM-dd hh:mm:ss"),
							ParentNumber:saveItems[i].firstElementChild.getAttribute('ParentNumber'),
							IntakeUseType: saveItems[i].firstElementChild.getAttribute('IntakeUseType'),
							Frequcy:saveItems[i].firstElementChild.getAttribute('Frequcy'),
							OrderCode: saveItems[i].firstElementChild.getAttribute('OrderCode'),
							IntakeCode:saveItems[i].firstElementChild.getAttribute('IntakeCode'),
							Value: thisTimes,
							Remarks: saveItems[i].firstElementChild.innerHTML
						})
					}
					mui.ajax({
						url: url,
						type: 'post',
						data: {
							msgBody: JSON.stringify(saveParam),
							msgHeader: JSON.stringify({
								ServerName: 'SaveIntake',
								Format: 'json',
								CallOperator: '',
								Certificate: '123456'
							})
						},
						beforeSend: function() {
							plus.nativeUI.showWaiting('正在保存中…');
						},
						dataType: 'json',
						success: function(data) {
							if(data.Code == 0) {
								setTimeout(function() {
									mui.toast('数据保存成功');
									plus.nativeUI.closeWaiting();
									listContainer.classList.remove('hasChange');
									mui.fire(detailMain, 'getParams', {
										hasChange: listContainer.classList.contains('hasChange')
									})
								}, 2000);

							} else {
								plus.nativeUI.closeWaiting();
								mui.toast('服务器异常，请稍后再试');
							}
						},
						error: function() {
							plus.nativeUI.closeWaiting();
							mui.toast('服务器异常');
						}
					})

				}
				//				获取输液单
				mui.ajax({
					url: url,
					type: 'get',
					data: {
						msgBody: JSON.stringify({
							PatientMRN: MRN,
							StartTime: new Date().Format("yyyy-MM-dd") + ' 07:00:01',
							EndTime: getNextDay() + " 07:00:00"
						}),
						msgHeader: JSON.stringify({
							ServerName: 'GetIntakeList',
							Format: 'json',
							CallOperator: '',
							Certificate: '123456'
						})
					},
					dataType: 'json',
					success: function(data) {  
						if(data.Code==0){
							var html = template('infusionTpl', {
							datas: data.Contents
							});
							document.getElementById('InfusionList').innerHTML = html;
							//				用药主界面的tab栏切换,放在success中
							//				获取每个输液组DOM
							var infusionGroups = document.getElementsByClassName('infusionGroup');
							var opers = document.getElementsByClassName('opers');
							var activeOpers = document.getElementsByClassName('activeOper');
							var operParts = document.getElementsByClassName('operPart');
							var sureUpdates = document.getElementsByClassName('sureUpdate');
							for(var i = 0; i < infusionGroups.length; i++) {
								infusionGroups[i].addEventListener('tap', function() {
									for(var j = 0; j < opers.length; j++) {
										opers[j].style.display = 'none';
									}
									this.lastElementChild.style.display = 'flex';
								})
							}
							//				如果是执行状态
							for(var n = 0; n < activeOpers.length; n++) {
								activeOpers[n].setAttribute('index', n);
								activeOpers[n].addEventListener('tap', function() {
									var activeIndex = parseInt(this.getAttribute('index'));
									for(var s = 0; s < operParts.length; s++) {
										operParts[s].style.display = 'none';
									}
									console.log(activeIndex);
									operParts[activeIndex].style.display = 'block';
								})
							}
							var checkBox = document.getElementById('isComplete');
							var totalValueDom = document.getElementById('totalValue');
							var ConsumptionValueDom = document.getElementById('ConsumptionValue');
							var pumpSpeedValueDom = document.getElementById('pumpSpeedValue');
							if(checkBox) {
								checkBox.addEventListener('change', function() {
									if(this.checked) {
										document.getElementsByClassName('status7').value = totalValueDom.innerHTML - ConsumptionValueDom.innerHTML;
										document.getElementById('affected').setAttribute('IsOver', '1');
									} else {
										document.getElementById('affected').setAttribute('IsOver', '0');
									}
								})
	
							}
							//				如果是暂停状态
							var begin = document.getElementById('begin');
							if(begin) {
								begin.addEventListener('tap', function() {
									this.nextElementSibling.style.display = 'block';
								})
							}
							var inputDoms = document.getElementsByClassName('inputDom');
							
	
							//				点击确认按钮
	
							for(var i = 0; i < sureUpdates.length; i++) {
								sureUpdates[i].addEventListener('tap', function() {
									var operateStatus = this.parentNode.getAttribute('status');
									var intakeNumber = operateStatus == 6 ? '0' : this.previousElementSibling.getElementsByClassName('fact')[0].value;
									var pumpValue = operateStatus == 1 ? document.getElementById('speedId').value : pumpSpeedValueDom.innerHTML;
									var itemTime = this.previousElementSibling.getElementsByClassName('itemTime')[0];
									var saveIntake = {
										OperateType: operateStatus,
										IntakeCode: this.getAttribute('IntakeCode'),
										PumpSpeed: pumpValue,
										OperateTime: new Date().Format("yyyy-MM-dd") + itemTime.value + ':00',
										UserCode: JSON.parse(window.localStorage.getItem('loginInfo')).UserName,
										UserName: JSON.parse(window.localStorage.getItem('loginInfo')).Name,
										IntakeNumber: intakeNumber,
										IsOver: this.getAttribute('isover')
									}
									mui.ajax({
										url: url,
										type: 'post',
										data: {
											msgBody: JSON.stringify(saveIntake),
											msgHeader: JSON.stringify({
												ServerName: 'SaveIntakeOperate',
												Format: 'json',
												CallOperator: '',
												Certificate: '123456'
											})
										},
										dataType: 'json',
										success: function(data) {
											if(data.Code == 0) {
												for(var s = 0; s < operParts.length; s++) {
													operParts[s].style.display = 'none';
												}
												itemTime.value = '选择时间';
												var facts = document.getElementsByClassName('fact');
												for(var j = 0; j < facts.length; j++) {
													facts[j].value = '';
												}
												document.getElementById('speedId').value = '';
												mui.toast('操作成功');
											} else {
												mui.toast('服务器错误');
											}
										}
									})
								})
							}

						}
						
					}
				})

				//				点击扫码
				var ScanCodeBtn = document.getElementById('ScanCodeBtn');
				var scanBtn = document.getElementById('scanBtn');
				//				获取第一次扫码的页面
				var firstScan = document.getElementById('firstScan');
				//				获取第二次扫码的页面
				var rescan = document.getElementById('rescan');
				//				获取失败扫码的页面
				var notHave = document.getElementById('notHave');
				//				第一次的操作按钮
				var firstSure = document.getElementById('firstSure');
				var restart = document.getElementById('restart');
				firstSure.addEventListener('tap', function() {
					mui.ajax({
						url: url,
						type: 'post',
						data: {
							msgBody: JSON.stringify({
								PatientMRN: MRN,
								StartTime: new Date().Format("yyyy-MM-dd") + ' 07:00:01',
								EndTime: getNextDay() + " 07:00:00",
								ImportType: "2",
								OrderNo: this.getAttribute('Order'),
								OperateTime: new Date().Format("yyyy-MM-dd") + document.getElementById('activeTime').value + ':00',
								UserCode: JSON.parse(window.localStorage.getItem('loginInfo')).UserName,
								UserName: JSON.parse(window.localStorage.getItem('loginInfo')).Name,
							}),
							msgHeader: JSON.stringify({
								ServerName: 'ImportOrderItem',
								Format: 'json',
								CallOperator: '',
								Certificate: '123456'
							})
						},
						beforeSend: function() {
							plus.nativeUI.showWaiting('液体导入中');
						},
						dataType: 'json',
						success: function(data) {
							if(data.Code == 0) {
								plus.nativeUI.closeWaiting();
								document.getElementById('medicationScan').innerHTML = '';
								firstScan.style.display = 'none';
								mui.toast('液体导入成功');

							}
						}
					})
				})
				//				第二次的操作按钮
				var sure = document.getElementById('sure');
				var rescanBtn = document.getElementById('rescanBtn');
				var operName = document.getElementById('operName');
				var total = document.getElementById('total');
				var actual = document.getElementById('actual');
				var speed = document.getElementById('speed');
				//				下拉选项
				var stop = document.getElementById('stop');
				var active = document.getElementById('active');
				//				下拉的显示
				operName.addEventListener('tap', function() {
					if(this.classList.contains('show')) {
						stop.style.display = 'none';
						active.style.display = 'none';
						this.classList.remove('show');
					} else {
						if(this.classList.contains('stop')) {
							active.style.display = 'none';
							stop.style.display = 'block';
						} else {
							active.style.display = 'block';
							stop.style.display = 'none';
						}
						this.classList.add('show');
					}
				})
				//				点击下拉的按钮
				var liObjs = document.getElementsByClassName('liObj');
				var continumBtn = document.getElementById('continue');
				continumBtn.addEventListener('tap', function() {
					operName.innerHTML = this.innerHTML;
					operName.setAttribute('status', this.getAttribute('status'));
					operName.setAttribute('isover', '0');
					var html = template('continueTpl', {});
					changePart.innerHTML = html;
					stop.style.display = 'none';
				})
				var changePart = document.getElementById('changePart');
				for(var i = 0; i < liObjs.length; i++) {
					liObjs[i].addEventListener('tap', function() {
						operName.innerHTML = this.innerHTML;
						operName.setAttribute('status', this.getAttribute('status'));
						operName.setAttribute('isover', '0');
						if(this.innerHTML == '修改泵速') {
							var html = template('updateTpl', {});
							changePart.innerHTML = html;
						} else if(this.innerHTML == '已用量') {
							var html = template('hasUseTpl', {});
							changePart.innerHTML = html;
							document.getElementById('isComplete').addEventListener('change', function() {
								if(this.checked) {
									operName.setAttribute('status', 9);
									operName.setAttribute('isover', '1');
									document.getElementById('actualNum').value = total.innerHTML - actual.innerHTML;
								} else {
									operName.setAttribute('status', 7);
									document.getElementById('actualNum').value = '';
									operName.setAttribute('isover', '0');
								}
							})
						} else if(this.innerHTML == '暂停') {
							var html = template('pauseTpl', {});
							changePart.innerHTML = html;
						} else if(this.innerHTML == '停止') {
							var html = template('stopTpl', {});
							changePart.innerHTML = html;
						}
						active.style.display = 'none';
					})
				}
				//				重复扫码时点击确认执行的操作
				sure.addEventListener('tap', function() {
					if(!operName.getAttribute('status')) {
						mui.toast('请选择对该液体的操作');
						return;
					}
					var actualNum = document.getElementById('actualNum') ? document.getElementById('actualNum').value : '0';
					mui.ajax({
						url: url,
						type: 'post',
						data: {
							msgBody: JSON.stringify({
								OperateType: operName.getAttribute('status'),
								IntakeCode: total.getAttribute('IntakeCode'),
								PumpSpeed: speed.value,
								OperateTime: new Date().Format("yyyy-MM-dd") + document.getElementById('doTime').value + ':00',
								UserCode: JSON.parse(window.localStorage.getItem('loginInfo')).UserName,
								UserName: JSON.parse(window.localStorage.getItem('loginInfo')).Name,
								IntakeNumber: actualNum,
								IsOver: operName.getAttribute('isover')
							}),
							msgHeader: JSON.stringify({
								ServerName: 'SaveIntakeOperate',
								Format: 'json',
								CallOperator: '',
								Certificate: '123456'
							})
						},
						dataType: 'json',
						success: function(data) {
							if(data.Code == 0) {
								rescan.style.display = 'none';
								operName.innerHTML = '操作<i></i>';
								mui.toast('操作成功');
							} else {
								mui.toast(data.Msg);
							}
						}
					})
				})
				//				没有的操作按钮
				var failScan = document.getElementById('failScan');

				function closeSubScan() {
					if(firstScan) {
						firstScan.style.display = 'none';
					}
					if(rescan) {
						rescan.style.display = 'none';
					}
					if(notHave) {
						notHave.style.display = 'none';
					}

				}
				document.getElementById('close').addEventListener('tap', closeSubScan);
				document.getElementById('closePage').addEventListener('tap', closeSubScan);
				document.getElementById('notHaveClose').addEventListener('tap', closeSubScan);
				//				摄像头扫码
				//				var scan = null;
				//					function onmarked( type, result ) {
				//					var text = '未知: ';
				//					switch(type){
				//						case plus.barcode.QR:
				//						text = 'QR: ';
				//						break;
				//						case plus.barcode.EAN13:
				//						text = 'EAN13: ';
				//						break;
				//						case plus.barcode.EAN8:
				//						text = 'EAN8: ';
				//						break;
				//					}
				//					
				//					mui.ajax({
				//						url:url,
				//						type:'get',
				//						data:{
				//							msgBody: JSON.stringify({
				//								"PatientMRN":MRN,     
				//								"OrderNo":result
				//							}),
				//							msgHeader: JSON.stringify({
				//								ServerName: 'ScanSearch',
				//								Format: 'json',
				//								CallOperator: '',
				//								Certificate: '123456'
				//							})
				//						},	
				//						dataType:'json',
				//						success:function(data){
				//							if(data.Code==0){
				//								if(data.Contents.length==0){
				//									plus.nativeUI.closeWaiting();
				//									notHave.style.display='block';
				//								}else if(data.Contents[0].OperateStatus=='-1'){
				////									导入药品
				//									plus.nativeUI.closeWaiting();							
				//									firstScan.style.display='block';
				//									for(var i=0;i<data.Contents.length;i++){
				//										var liObj=document.createElement('li');
				//										liObj.innerHTML=data.Contents[i].Remarks;
				//										document.getElementById('medicationScan').appendChild(liObj);
				//									}
				//									document.getElementById('liquidNum').innerHTML=data.Contents[0].PumpSpeed;
				//									document.getElementById('activeTime').value=data.Contents[0].OperateTime.substr(data.Contents[0].OperateTime.indexOf(' '),6);
				//									firstSure.setAttribute('Order',result);
				//								}else if(data.Contents[0].OperateStatus!='-1'){
				//									var status=data.Contents[0].OperateStatus;
				////									重复扫药品
				//									plus.nativeUI.closeWaiting();
				//									rescan.style.display='block';
				//									for(var i=0;i<data.Contents.length;i++){
				//										var liObj=document.createElement('li');
				//										liObj.innerHTML=data.Contents[i].Remarks;
				//										document.getElementById('remedicationScan').appendChild(liObj);
				//									}
				//									total.innerHTML=data.Contents[0].IntakeTotal;
				//									actual.innerHTML=data.Contents[0].IntakeUsed;
				//									speed.value=data.Contents[0].PumpSpeed;
				//									total.setAttribute('IntakeCode',data.Contents[0].IntakeCode);
				//									if(status==0 || status==1 || status==5 || status==7) {
				//										operName.classList.remove('stop');
				//										
				//									}else if(status==4 || status==8 || status==9) {
				//										rescan.style.display='none';
				//										mui.toast('该组液体无法继续操作');
				//									}else if(status==6) {
				//										operName.classList.add('stop');
				//									}
				//								}
				//							}else{
				//								plus.nativeUI.closeWaiting();
				//								notHave.style.display='block';
				//								
				//							}
				//							scan.close();
				//							document.getElementById('scanCon').style.display='none';
				//							
				//						},
				//						error:function(){
				//							plus.nativeUI.closeWaiting();
				//							notHave.style.display='block';
				//							scan.close();
				//							document.getElementById('scanCon').style.display='none';
				//						}
				//					})
				//	
				//					}
				//					function onerror(){
				//						mui.toast('扫描错误，请检查条码重新扫描');
				//					}
				//					function startRecognize() {
				//						closeSubScan();
				//						document.getElementById('scanCon').style.display='block';
				//						scan = new plus.barcode.Barcode('SCAN');
				//						scan.onmarked = onmarked; 
				//						scan.start();
				//					}	
				//					function closeScan(){
				//						scan.close();
				//						document.getElementById('scanCon').style.display='none';
				//					}	
				//				ScanCodeBtn.addEventListener('tap',startRecognize);
				//				rescanBtn.addEventListener('tap',startRecognize);
				//				restart.addEventListener('tap',startRecognize);
				//				failScan.addEventListener('tap',startRecognize);
				//				document.getElementById('cancel').addEventListener('tap',closeScan);			
//				手动扫描获取二维码打开页面,获取药品
				var context = plus.android.importClass('android.content.Context'); //上下文
				var main = plus.android.runtimeMainActivity(); //获取activity
				var receiver = plus.android.implements('io.dcloud.feature.internal.reflect.BroadcastReceiver', {
					onReceive: doReceive //实现onReceiver回调函数
				});
				var IntentFilter = plus.android.importClass('android.content.IntentFilter');
				var Intent = plus.android.importClass('android.content.Intent');
				var filter = new IntentFilter();

				filter.addAction("lachesis_barcode_value_notice_broadcast"); //监听扫码状态
				main.registerReceiver(receiver, filter); //注册监听
							function doReceive(context, intent) {
				closeSubScan();
				var intentCode = intent.getStringExtra("lachesis_barcode_value_notice_broadcast_data_string");
				if(/^\d{7}$/.test(intentCode)) {
					mui.ajax({
						url: url,
						type: 'get',
						data: {
							msgBody: JSON.stringify({
								"PatientMRN": MRN,
								     
								"OrderNo": intentCode
							}),
							msgHeader: JSON.stringify({
								ServerName: 'ScanSearch',
								Format: 'json',
								CallOperator: '',
								Certificate: '123456'
							})
						},
						dataType: 'json',
						success: function(data) {
							if(data.Code == 0) {

								console.log(data.Contents[0].OperateStatus);
								if(data.Contents.length == 0) {
									plus.nativeUI.closeWaiting();
									notHave.style.display = 'block';
								} else if(data.Contents[0].OperateStatus == '-1') {
									//									导入药品
									plus.nativeUI.closeWaiting();
									firstScan.style.display = 'block';
									document.getElementById('medicationScan').innerHTML = '';
									for(var i = 0; i < data.Contents.length; i++) {
										var liObj = document.createElement('li');
										liObj.innerHTML = data.Contents[i].Remarks;
										document.getElementById('medicationScan').appendChild(liObj);
									}
									document.getElementById('liquidNum').innerHTML = data.Contents[0].PumpSpeed;
									document.getElementById('activeTime').value = data.Contents[0].OperateTime.substr(data.Contents[0].OperateTime.indexOf(' '), 6);
									firstSure.setAttribute('Order', handScan.value);
								} else if(data.Contents[0].OperateStatus != '-1') {
									var status = data.Contents[0].OperateStatus;
									//									重复扫药品
									plus.nativeUI.closeWaiting();
									rescan.style.display = 'block';
									document.getElementById('remedicationScan')
									for(var i = 0; i < data.Contents.length; i++) {
										var liObj = document.createElement('li');
										liObj.innerHTML = data.Contents[i].Remarks;
										document.getElementById('remedicationScan').appendChild(liObj);
									}
									total.innerHTML = data.Contents[0].IntakeTotal;
									actual.innerHTML = data.Contents[0].IntakeUsed;
									speed.value = data.Contents[0].PumpSpeed;
									total.setAttribute('IntakeCode', data.Contents[0].IntakeCode);
									if(status == 0 || status == 1 || status == 5 || status == 7) {
										operName.classList.remove('stop');

									} else if(status == 4 || status == 8 || status == 9) {
										rescan.style.display = 'none';
										mui.toast('该组液体无法继续操作');
									} else if(status == 6) {
										operName.classList.add('stop');
									}
								}
							} else {
								plus.nativeUI.closeWaiting();
								notHave.style.display = 'block';

							}
						},
						error: function() {
							plus.nativeUI.closeWaiting();
							notHave.style.display = 'block';

						}
					})

				} else {
					mui.toast('请扫描正确的二维码');
				}
			}

			}

		</script>
		<script src="../js/updateTime.js"></script>
	</body>

</html>